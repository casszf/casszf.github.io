<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BAGELS DELIVERY!</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.png" />
  <style>
    @font-face {
      font-family: 'LTPerfume';
      src: url('LTPerfume.woff2') format('woff2'),
           url('LTPerfume.woff') format('woff');
      font-display: swap;
    }
    @font-face {
      font-family: 'RomanAcid';
      src: url('RomanAcid.woff2') format('woff2'),
           url('RomanAcid.woff') format('woff');
      font-display: swap;
    }
    body {
      margin: 0;
      font-family: Georgia, serif;
      font-size: 18px;
      background-color: #fef3bd;
      padding: 0.5rem;
      color: #111;
    }
    .topbar {
      margin-bottom: 2rem;
    }
    .topbar img.logo {
      height: 40px;
    }
    .content {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    .delivery-title {
      font-size: 24px;
      font-family: RomanAcid, sans-serif;
      margin-bottom: 1rem;
    }
    .delivery-info {
      font-family: 'LTPerfume', serif;
      font-size: 26px;
      white-space: pre-line;
      margin-bottom: 2rem;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }
    input[type="text"] {
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      max-width: 300px;
      font-family: Georgia, serif;
      font-weight: normal;
    }
    label,legend {
      font-weight: normal;   /* enlÃ¨ve le gras */
      font-size: 1rem;       /* fixe une taille uniforme (ex. 16px/1rem) */
      font-family: Georgia, serif;  /* garde la mÃªme police que le reste du texte */
    }
      
    }
    button {
      padding: 0.5rem 1.5rem;
      background-color: black;
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      font-family: Georgia, serif;
      margin-top: 1rem;
    }
    .success-message {
      display: none;
      text-align: center;
      font-weight: bold;
      margin-top: 2rem;
    }
    form.success + .success-message {
      display: block;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <a href="index.html"><img src="favicon.png" alt="Favicon" class="logo" /></a>
  </header>
  <main class="content" id="main-content">
    <p class="delivery-title">BAGELS DELIVERY!</p>
    <div class="popup-info">
<br>vendredi 5 septembre<br />
<br>lunch time 12h - 13h30<br />
<br>paris 75001/2/8/9/10 uniquementðŸ’‹<br />
<br>paiement lors de la livraison<br />
    <br><br />
    </div>

    <!-- Formulaire -->
<form id="commande" action="ACTION_URL_ICI" method="POST" accept-charset="UTF-8">
  <!-- Anti-spam -->
  <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" aria-hidden="true" style="position:absolute;left:-9999px;">
  <input type="hidden" name="_subject" value="Nouvelle commande de bagels - Orbite">

  <!-- CoordonnÃ©es -->
  <div>
    <label for="prenom">PrÃ©nom</label>
    <input id="prenom" name="prenom" type="text" required autocomplete="given-name">
  </div>
  <div>
    <label for="nom">Nom</label>
    <input id="nom" name="nom" type="text" required autocomplete="family-name">
  </div>
  <div>
    <label for="telephone">TÃ©lÃ©phone (06 / +33)</label>
    <input id="telephone" name="telephone" type="tel" required
           pattern="^(?:0[1-9]\\d{8}|(?:\\+33|0033)[1-9]\\d{8})$"
           placeholder="06XXXXXXXX ou +336XXXXXXXX">
  </div>
  <div>
    <label for="adresse">Adresse</label>
    <input id="adresse" name="adresse" type="text" required autocomplete="street-address">
  </div>

  <!-- Bagels dynamiques -->
  <fieldset>
    <legend>Bagels</legend>
    <div id="bagels"></div>
    <button type="button" id="addBagel">Ajouter un bagel</button>
  </fieldset>

  <!-- Boisson -->
  <fieldset>
    <legend>Boisson</legend>
    <label for="boisson_qty">ThÃ© vert glacÃ© citron & fleur de sureau (3â‚¬) â€” QuantitÃ©</label>
    <input id="boisson_qty" name="boisson_qty" type="number" min="0" step="1" value="0" inputmode="numeric">
  </fieldset>

  <!-- Commentaires -->
  <div>
    <label for="commentaires">Commentaires (optionnel)</label>
    <textarea id="commentaires" name="commentaires" rows="3" placeholder="Allergies, etc."></textarea>
  </div>

   <!-- Consentement -->
  <label><input type="checkbox" id="consent" required> Jâ€™accepte lâ€™utilisation de mes infos pour traiter ma commande.</label>

  <!-- Total -->
  <div>
    <strong>Total :</strong> <span id="total">0,00 â‚¬</span>
  </div>

  <!-- Actions -->
  <div>
    <button type="submit">Soumettre la commande</button>
    <span id="form-msg"></span>
  </div>
  <div id="form-error" style="display:none;color:#b00020;">Veuillez sÃ©lectionner au moins un bagel ou une boisson.</div>
</form>

    <script>
(() => {
  // Tarifs & constantes
  const PRICES = {
    original: { half: 8.0, whole: 14.0 },
    peters:   { half: 6.0, whole: 11.0 },
    summer:   { half: 6.0, whole: 11.0 },
    almond:   { single: 5.0 }, // pas de moitiÃ©/entier prÃ©cisÃ© -> tarif unique
    sardine_per_half: 1.5,
    drink: 3.0
  };
  const CURRENCIES = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });

  const form = document.getElementById('commande');
  const bagelsWrap = document.getElementById('bagels');
  const addBtn = document.getElementById('addBagel');
  const totalEl = document.getElementById('total');
  const boissonQtyEl = document.getElementById('boisson_qty');
  const formError = document.getElementById('form-error');
  const formMsg = document.getElementById('form-msg');
  const merci = document.getElementById('merci');
  const btnNew = document.getElementById('newOrder');

  let bagelIdx = 0;

  function addBagelRow(prefill={}) {
    const idx = bagelIdx++;
    const row = document.createElement('div');
    row.setAttribute('data-idx', idx);

    // Recette
    const recipeLabel = document.createElement('label');
    recipeLabel.setAttribute('for', `recipe_${idx}`);
    recipeLabel.textContent = 'Recette';
    const recipeSelect = document.createElement('select');
    recipeSelect.id = `recipe_${idx}`;
    recipeSelect.name = 'recipe[]';
    [
      {v:'original', t:"Original â€” truite fumÃ©e (8â‚¬ moitiÃ© / 14â‚¬ entier)"},
      {v:'peters',   t:"Peterâ€™s favorite â€” concombres (6â‚¬ moitiÃ© / 11â‚¬ entier)"},
      {v:'summer',   t:"High summer â€” tomates (6â‚¬ moitiÃ© / 11â‚¬ entier)"},
      {v:'almond',   t:"Almond butter & jam â€” 5â‚¬"}
    ].forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.v; opt.textContent = o.t;
      recipeSelect.appendChild(opt);
    });

    // Taille (moitiÃ©/entier) â€” seulement pour original/peters/summer
    const sizeLabel = document.createElement('label');
    sizeLabel.setAttribute('for', `size_${idx}`);
    sizeLabel.textContent = 'Taille';
    const sizeSelect = document.createElement('select');
    sizeSelect.id = `size_${idx}`;
    sizeSelect.name = 'size[]';
    [
      {v:'half', t:'MoitiÃ©'},
      {v:'whole', t:'Entier'}
    ].forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.v; opt.textContent = o.t;
      sizeSelect.appendChild(opt);
    });

    // Pain (sÃ©same/pavot/nature)
    const breadLabel = document.createElement('label');
    breadLabel.setAttribute('for', `bread_${idx}`);
    breadLabel.textContent = 'Pain';
    const breadSelect = document.createElement('select');
    breadSelect.id = `bread_${idx}`;
    breadSelect.name = 'bread[]';
    ['sÃ©same','pavot','nature'].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      breadSelect.appendChild(opt);
    });

    // Vegan cream cheese (sans supplÃ©ment)
    const veganLabel = document.createElement('label');
    veganLabel.setAttribute('for', `vegan_${idx}`);
    veganLabel.textContent = 'Cream cheese vegan (sans supplÃ©ment)';
    const veganInput = document.createElement('input');
    veganInput.type = 'checkbox';
    veganInput.id = `vegan_${idx}`;
    veganInput.name = 'vegan[]';
    veganInput.value = 'oui';

    // QuantitÃ© de bagels (ex. 1,2,3 du mÃªme rÃ©glage)
    const qtyLabel = document.createElement('label');
    qtyLabel.setAttribute('for', `qty_${idx}`);
    qtyLabel.textContent = 'QuantitÃ©';
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.id = `qty_${idx}`;
    qtyInput.name = 'qty[]';
    qtyInput.min = '1';
    qtyInput.step = '1';
    qtyInput.value = String(prefill.qty || 1);
    qtyInput.inputMode = 'numeric';

    // Sardines en extra â€” par moitiÃ©
    const sardWrap = document.createElement('div');
    sardWrap.id = `sard_wrap_${idx}`;
    
    const sardLabel = document.createElement('label');
    sardLabel.setAttribute('for', `sard_${idx}`);
    sardLabel.textContent = 'Sardines en extra (nb de moitiÃ©s)';
    
    const sardInput = document.createElement('input');
    sardInput.type = 'number';
    sardInput.id = `sard_${idx}`;
    sardInput.name = 'sardines_halves[]';
    sardInput.min = '0';
    sardInput.step = '1';
    sardInput.value = '0';
    sardInput.inputMode = 'numeric';
    
    sardWrap.appendChild(sardLabel);
    sardWrap.appendChild(sardInput);

    // Prix de ligne
    const lineTotal = document.createElement('div');
    lineTotal.id = `lineTotal_${idx}`;
    lineTotal.textContent = '0,00 â‚¬';

    // Bouton supprimer
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = 'Supprimer ce bagel';
    delBtn.addEventListener('click', () => { row.remove(); recalc(); });

    // Aligner logique: taille masquÃ©e si almond
    function syncVisibility() {
      const isAlmond = (recipeSelect.value === 'almond');
       // Taille cachÃ©e si almond
      sizeLabel.style.display = isAlmond ? 'none' : '';
      sizeSelect.style.display = isAlmond ? 'none' : '';

      // Sardines cachÃ©es si almond
      sardWrap.style.display = isAlmond ? 'none' : '';

      // borne max sardines = nb de moitiÃ©s dans la ligne
      const qty = parseInt(qtyInput.value || '0', 10);
      const halvesPerUnit = isAlmond ? 2 : (sizeSelect.value === 'whole' ? 2 : 1);
      const maxHalves = halvesPerUnit * qty;
      sardInput.max = String(maxHalves);
      // clamp
      if (parseInt(sardInput.value || '0', 10) > maxHalves) sardInput.value = String(maxHalves);
    }

    function linePrice() {
      const recipe = recipeSelect.value;
      const qty = parseInt(qtyInput.value || '0', 10);
      let base = 0;

      if (recipe === 'almond') {
        base = PRICES.almond.single * qty;
      } else {
        const size = sizeSelect.value; // half|whole
        const p = PRICES[recipe][size];
        base = p * qty;
      }
      const sardHalves = parseInt(sardInput.value || '0', 10);
      const sardCost = sardHalves * PRICES.sardine_per_half;

      return base + sardCost;
    }

    function updateLine() {
      syncVisibility();
      lineTotal.textContent = CURRENCIES.format(linePrice());
      recalc();
    }

    // Events
    recipeSelect.addEventListener('change', updateLine);
    sizeSelect.addEventListener('change', updateLine);
    breadSelect.addEventListener('change', updateLine);
    veganInput.addEventListener('change', updateLine);
    qtyInput.addEventListener('input', updateLine);
    sardInput.addEventListener('input', updateLine);

    // Remplir valeurs par dÃ©faut utiles
    if (prefill.recipe) recipeSelect.value = prefill.recipe;
    if (prefill.size) sizeSelect.value = prefill.size;
    updateLine();

    // Regroupe tous les champs (orde simple, sans styles)
    row.appendChild(recipeLabel);
    row.appendChild(recipeSelect);
    row.appendChild(sizeLabel);
    row.appendChild(sizeSelect);
    row.appendChild(breadLabel);
    row.appendChild(breadSelect);
    row.appendChild(veganLabel);
    row.appendChild(veganInput);
    row.appendChild(qtyLabel);
    row.appendChild(qtyInput);
    row.appendChild(sardLabel);
    row.appendChild(sardInput);
    row.appendChild(sardWrap);
    row.appendChild(document.createTextNode('Total ligne : '));
    row.appendChild(lineTotal);
    row.appendChild(delBtn);
    

    bagelsWrap.appendChild(row);
  }

  function recalc() {
    // Total bagels
    let sum = 0;
    bagelsWrap.querySelectorAll('div[data-idx]').forEach(row => {
      const idx = row.getAttribute('data-idx');
      const lt = row.querySelector(`#lineTotal_${idx}`);
      if (lt) {
        const txt = lt.textContent.replace(/[\\sâ‚¬]/g,'').replace(',','.');
        const val = parseFloat(txt || '0');
        if (!isNaN(val)) sum += val;
      }
    });

    // Boissons
    const drinkQty = parseInt(boissonQtyEl.value || '0', 10);
    if (drinkQty > 0) sum += drinkQty * PRICES.drink;

    totalEl.textContent = CURRENCIES.format(sum);
  }

  // Ajouter au moins 1 bagel au chargement
  addBtn.addEventListener('click', () => addBagelRow({}));
  addBagelRow({});

  // Recalcul quand quantitÃ© boisson change
  boissonQtyEl.addEventListener('input', recalc);

  // Soumission AJAX
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    formError.style.display = 'none';
    formMsg.textContent = '';

    const hasAnyBagel = bagelsWrap.querySelectorAll('div[data-idx]').length > 0;
    const hasDrink = parseInt(boissonQtyEl.value || '0', 10) > 0;
    if (!hasAnyBagel && !hasDrink) {
      formError.style.display = '';
      return;
    }

    // Construire le payload
    const data = new FormData(form);

    // SÃ©rialiser lignes bagel pour lecture/CSV
    const resume = [];
    bagelsWrap.querySelectorAll('div[data-idx]').forEach(row => {
      const idx = row.getAttribute('data-idx');
      const recipe = row.querySelector(`#recipe_${idx}`).value;               data.append('recipe[]', recipe);
      const sizeEl = row.querySelector(`#size_${idx}`);
      const size = sizeEl && sizeEl.style.display !== 'none' ? sizeEl.value : 'single';
      data.append('size[]', size);
      const bread = row.querySelector(`#bread_${idx}`).value;                 data.append('bread[]', bread);
      const vegan = row.querySelector(`#vegan_${idx}`).checked ? 'oui' : 'non'; data.append('vegan[]', vegan);
      const qty = row.querySelector(`#qty_${idx}`).value;                     data.append('qty[]', qty);
      const sard = row.querySelector(`#sard_${idx}`).value;                   data.append('sardines_halves[]', sard);

      // Prix ligne pour rÃ©sumÃ©
      const lineTxt = row.querySelector(`#lineTotal_${idx}`).textContent || '0,00 â‚¬';
      resume.push(`${recipe} | ${size} | pain:${bread} | vegan:${vegan} | qte:${qty} | sardines(Â½):${sard} | ${lineTxt}`);
    });

    data.append('boisson_the_vert_glace_qte', boissonQtyEl.value || '0');
    data.append('total_eur', totalEl.textContent);
    data.append('panier', resume.join(' || '));

    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: data
      });
      if (resp.ok) {
        // Reset et "merci"
        form.reset();
        bagelsWrap.innerHTML = '';
        addBagelRow({});
        recalc();
        form.style.display = 'none';
        merci.style.display = '';
      } else {
        formMsg.textContent = "Erreur dâ€™envoi. RÃ©essayez ou contactez-nous.";
      }
    } catch (err) {
      formMsg.textContent = "RÃ©seau indisponible. Merci de rÃ©essayer.";
    }
  });

  if (btnNew) {
    btnNew.addEventListener('click', () => {
      merci.style.display = 'none';
      form.style.display = '';
    });
  }
})();
</script>


    <!-- Bloc "merci" affichÃ© aprÃ¨s envoi -->
<div id="merci" style="display:none">
  <h2>Merci ðŸŽ‰</h2>
  <p>commande confirmÃ©e! vous recevrez un message au moment de la livraisonðŸ¥¯</p>
  <button id="newOrder" type="button">Passer une autre commande</button>
</div>

  
